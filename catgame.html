<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Игра с котиком</title>
    <style>
        @font-face {
            font-family: 'JoyStix';
            src: url('joystix.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: url('background.png') no-repeat center center fixed;
            background-size: cover;
            font-family: 'JoyStix', sans-serif;
            touch-action: none;
        }
        #game-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            width: 100%;
            max-width: 600px;
            height: 100vh;
        }
        #game-container {
            position: relative;
            width: 600px;
            height: 600px;
            border-radius: 30px;
            overflow: hidden;
            border: 6px solid rgba(255,255,255,0.9);
        }
        #cat {
            position: absolute;
            transition: top 0.1s ease-out;
            z-index: 10;
            background-size: cover;
        }
        @keyframes jumpAnimation {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .platform {
            position: absolute;
            background: url('platform.png') no-repeat center center;
            background-size: cover;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 5;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
        .bonus {
            position: absolute;
            z-index: 15;
            transition: transform 0.3s ease;
        }
        .bonus:hover {
            transform: scale(1.2);
        }
        .heart-bonus {
            background: url('life.png') no-repeat center center;
            background-size: cover;
            animation: float 1.5s infinite;
        }
        .food-bonus {
            background: url('food.png') no-repeat center center;
            background-size: cover;
            animation: float 1.5s infinite;
        }
        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        #dog {
            position: absolute;
            background: url('dog.png') no-repeat center center;
            background-size: cover;
            border-radius: 4px;
            z-index: 10;
            animation: wag 0.5s infinite;
        }
        @keyframes wag {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
        #nut {
            position: absolute;
            background: url('nut.png') no-repeat center center;
            background-size: cover;
            border-radius: 50%;
            z-index: 10;
        }
        .spikes {
            position: absolute;
            z-index: 12;
            animation: bounce 2s infinite; /* Добавлена анимация как у платформ */
        }
        .spike {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 10px solid #000;
        }
        #score, #steps, #menu, #game-over, #win-screen, button {
            font-family: 'JoyStix', sans-serif;
            color: #fff;
            -webkit-text-stroke: 1px #000;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        #version {
            font-family: 'JoyStix', sans-serif;
            color: #fff;
            position: absolute;
            top: 2%;
            right: 5%;
            font-size: 12px;
            z-index: 20;
        }
        #score {
            position: absolute;
            top: 5%;
            left: 5%;
            padding: 1% 2%;
            border-radius: 12px;
            z-index: 20;
        }
        #steps {
            position: absolute;
            top: 15%;
            left: 5%;
            padding: 1% 2%;
            border-radius: 12px;
            z-index: 20;
        }
        #lives {
            position: absolute;
            top: 5%;
            right: 5%;
            display: flex;
            gap: 4px;
            z-index: 20;
        }
        .heart {
            background: url('life.png') no-repeat center center;
            background-size: cover;
            animation: heartbeat 1s infinite;
        }
        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        #menu, #game-over, #win-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            z-index: 25;
            animation: pop 0.5s ease-in-out;
            width: 80%;
            max-width: 400px;
        }
        #menu h1 {
            font-size: 36px;
            margin: 0 0 15px 0;
        }
        #menu p {
            font-size: 20px;
            margin: 0 0 20px 0;
        }
        #menu button {
            margin: 10px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 15px 20px 25px 20px;
        }
        #pushok-btn::before, #fenya-btn::before {
            content: '';
            display: inline-block;
            width: 50px;
            height: 50px; /* Увеличено для полного отображения */
            background-size: contain; /* Чтобы иконки не обрезались */
            background-repeat: no-repeat;
            background-position: center;
        }
        #pushok-btn::before {
            background-image: url('pushok.png');
        }
        #fenya-btn::before {
            background-image: url('fenya.png');
        }
        @keyframes pop {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        #game-over {
            background: rgba(255, 105, 97, 0.9);
        }
        #win-screen {
            background: rgba(255, 182, 193, 0.9);
        }
        .controls {
            display: flex;
            justify-content: space-between;
            width: 600px;
            gap: 20px;
            padding: 10px;
            box-sizing: border-box;
            z-index: 1000;
            user-select: none;
        }
        .left-controls {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            z-index: 1001;
        }
        button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .blink { animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .score-pop {
            position: absolute;
            z-index: 20;
            animation: scoreFade 1s forwards;
            font-family: 'JoyStix', sans-serif;
            -webkit-text-stroke: 1px #000;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        .heart-pop { color: #ff1493; }
        .food-pop { color: #8b4513; }
        @keyframes scoreFade {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-15px) scale(1.2); }
        }
        .star-particle {
            position: absolute;
            width: 5px;
            height: 5px;
            background: yellow;
            border-radius: 50%;
            z-index: 20;
            animation: starFade 0.5s forwards;
        }
        @keyframes starFade {
            0% { opacity: 1; transform: scale(1) translate(0, 0); }
            100% { opacity: 0; transform: scale(1.5) translate(var(--dx), var(--dy)); }
        }

        @media only screen and (max-width: 600px) {
            body {
                display: block;
            }
            #game-wrapper {
                width: 100vw;
                height: 100vh;
            }
            #game-container {
                width: 100vw;
                height: calc(100vh - 120px);
                border-radius: 0;
                border: none;
                position: relative;
                top: 0;
                left: 0;
                transform: none;
            }
            #score {
                top: 2%;
            }
            #steps {
                top: 8%;
            }
            #version {
                top: 2%;
                right: 5%;
                font-size: 10px;
            }
            .controls {
                position: fixed;
                bottom: 10px;
                width: 100vw;
                height: 120px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                background: rgba(255,255,255,0.1);
                backdrop-filter: blur(10px);
                z-index: 1000;
            }
            #menu, #game-over, #win-screen {
                width: 90%;
                max-width: 90vw;
                padding: 15px;
            }
            #menu h1 {
                font-size: 28px;
            }
            #menu p {
                font-size: 16px;
            }
            button {
                padding: 20px 40px;
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="score">Очки: 0</div>
            <div id="steps">Ступень: 1</div>
            <div id="version">v1.18</div>
            <div id="lives"></div>
            <div id="cat"></div>
            <div id="menu">
                <h1>Приключение Пушка и Фени</h1>
                <p>Остерегайся пробегающих собак и падающих орехов!</p>
                <button id="pushok-btn">Пушок</button>
                <button id="fenya-btn">Феня</button>
            </div>
            <div id="game-over" style="display: none;">
                <h2>Игра окончена!</h2>
                <p id="final-score">Очки: 0</p>
                <p id="final-steps">Ступеней: 0</p>
                <button id="restart-btn">Играть заново</button>
            </div>
            <div id="win-screen" style="display: none;">
                <h2>Поздравляю с 8 Марта!</h2>
                <button id="continue-btn">Продолжить игру</button>
            </div>
        </div>
        <div class="controls">
            <div class="left-controls">
                <button id="left-btn">←</button>
                <button id="right-btn">→</button>
            </div>
            <button id="jump-btn">↑</button>
        </div>
    </div>

    <script>
        const gameContainer = document.getElementById('game-container');
        const cat = document.getElementById('cat');
        const scoreDisplay = document.getElementById('score');
        const stepsDisplay = document.getElementById('steps');
        const livesDisplay = document.getElementById('lives');
        const menu = document.getElementById('menu');
        const gameOver = document.getElementById('game-over');
        const winScreen = document.getElementById('win-screen');
        const finalScore = document.getElementById('final-score');
        const finalSteps = document.getElementById('final-steps');

        // Элементы управления
        const pushokBtn = document.getElementById('pushok-btn');
        const fenyaBtn = document.getElementById('fenya-btn');
        const restartBtn = document.getElementById('restart-btn');
        const continueBtn = document.getElementById('continue-btn');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const jumpBtn = document.getElementById('jump-btn');

        // Звуки
        const woofSound = new Audio('woof.wav');
        const bonusSound = new Audio('bonus.wav');
        const jumpSound = new Audio('jump.wav');
        const nutSound = new Audio('nut.wav');
        const meowSound = new Audio('meow.wav');

        // Динамические размеры в зависимости от устройства
        const isMobile = window.innerWidth <= 600;
        const baseWidth = isMobile ? window.innerWidth : 600;
        const baseHeight = isMobile ? window.innerHeight - 120 : 600;
        const scaleFactor = baseWidth / 600;

        // Применяем размеры
        gameContainer.style.width = `${baseWidth}px`;
        gameContainer.style.height = `${baseHeight}px`;

        let catX = baseWidth / 2 - 24 * scaleFactor, catY = 0, velocityY = 0, isJumping = false;
        let score = 0, lives = 1, platforms = [], bonuses = [], spikes = [], dog = null, nut = null;
        let movingLeft = false, movingRight = false;
        let selectedCat = null, worldOffset = 0;
        let gameActive = true, visitedPlatforms = new Set();
        let platformCount = 0;
        let currentPlatform = null;
        let steps = 0;
        let hasWon = false;
        let catFacingRight = false;

        // Адаптация размеров элементов
        cat.style.width = `${48 * scaleFactor}px`;
        cat.style.height = `${40 * scaleFactor}px`;
        document.querySelectorAll('.heart').forEach(heart => {
            heart.style.width = `${25 * scaleFactor}px`;
            heart.style.height = `${25 * scaleFactor}px`;
        });

        // Обработчики событий для кнопок с поддержкой мультитач
        const touches = new Map();

        pushokBtn.addEventListener('click', () => startGame('pushok'));
        pushokBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startGame('pushok'); });
        fenyaBtn.addEventListener('click', () => startGame('fenya'));
        fenyaBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startGame('fenya'); });
        restartBtn.addEventListener('click', restartGame);
        restartBtn.addEventListener('touchstart', (e) => { e.preventDefault(); restartGame(); });
        continueBtn.addEventListener('click', continueGame);
        continueBtn.addEventListener('touchstart', (e) => { e.preventDefault(); continueGame(); });

        leftBtn.addEventListener('mousedown', () => moveLeft(true));
        leftBtn.addEventListener('mouseup', () => moveLeft(false));
        rightBtn.addEventListener('mousedown', () => moveRight(true));
        rightBtn.addEventListener('mouseup', () => moveRight(false));
        jumpBtn.addEventListener('mousedown', jump);

        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            for (let touch of e.changedTouches) {
                touches.set(touch.identifier, 'left');
                moveLeft(true);
            }
        });
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            for (let touch of e.changedTouches) {
                touches.set(touch.identifier, 'right');
                moveRight(true);
            }
        });
        jumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            for (let touch of e.changedTouches) {
                touches.set(touch.identifier, 'jump');
                jump();
            }
        });

        document.addEventListener('touchend', (e) => {
            e.preventDefault();
            for (let touch of e.changedTouches) {
                const action = touches.get(touch.identifier);
                if (action === 'left') moveLeft(false);
                if (action === 'right') moveRight(false);
                touches.delete(touch.identifier);
            }
        });

        document.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            for (let touch of e.changedTouches) {
                const action = touches.get(touch.identifier);
                if (action === 'left') moveLeft(false);
                if (action === 'right') moveRight(false);
                touches.delete(touch.identifier);
            }
            movingLeft = false;
            movingRight = false;
        });

        function startGame(catType) {
            selectedCat = catType;
            cat.style.backgroundImage = `url(${catType === 'pushok' ? 'pushok1.png' : 'fenya1.png'})`;
            cat.style.backgroundColor = 'transparent';
            catFacingRight = false;
            cat.style.transform = 'scaleX(-1)'; // Начально смотрит влево
            menu.style.display = 'none';
            initGame();
            console.log(`Котик выбран: ${catType === 'pushok' ? 'Пушок' : 'Феня'}`);
            spawnDogRandomly();
            spawnNutRandomly();
        }

        function initGame() {
            platformCount = 0;
            visitedPlatforms.clear();
            platforms.forEach(p => p.element.remove());
            bonuses.forEach(b => b.element.remove());
            spikes.forEach(s => s.element.remove());
            if (dog) dog.element.remove();
            if (nut) nut.element.remove();
            bonuses = [];
            platforms = [];
            spikes = [];
            dog = null;
            nut = null;
            generateInitialPlatforms();
            
            catX = platforms[0].x + platforms[0].width / 2 - 24 * scaleFactor;
            catY = platforms[0].y - 40 * scaleFactor;
            currentPlatform = platforms[0];
            cat.style.left = `${catX}px`;
            cat.style.top = `${catY}px`;
            worldOffset = 0;
            lives = 1;
            score = 0;
            steps = 0;
            gameActive = true;
            isJumping = false;
            velocityY = 0;
            movingLeft = false;
            movingRight = false;
            hasWon = false;
            updateScore();
            updateSteps();
            updateLives();
            gameLoop();
        }

        function generateInitialPlatforms() {
            for (let i = 0; i < 10; i++) {
                addNewPlatform();
            }
        }

        function addNewPlatform() {
            platformCount++;
            const maxJumpHeight = 150 * scaleFactor;
            const maxJumpDistance = 150 * scaleFactor;
            const minHorizontalGap = 100 * scaleFactor;
            const maxHorizontalGap = 240 * scaleFactor;
            const minVerticalGap = 179 * scaleFactor;
            const maxVerticalGap = 212 * scaleFactor;
            const direction = Math.random() < 0.5 ? -1 : 1;
            const x = platforms.length ? 
                Math.max(0, Math.min(baseWidth - 100 * scaleFactor, 
                    platforms[platforms.length - 1].x + direction * (Math.random() * (maxHorizontalGap - minHorizontalGap) + minHorizontalGap))) : 
                Math.floor(Math.random() * (baseWidth - 100 * scaleFactor)) + 50 * scaleFactor;
            const y = platforms.length ? 
                platforms[platforms.length - 1].y - (Math.random() * (maxVerticalGap - minVerticalGap) + minVerticalGap) : 
                baseHeight * 0.8 - 40 * scaleFactor;
            const isSmall = platformCount % 10 === 0 && Math.random() > 0.5;
            let width = isSmall ? 50 * scaleFactor : 100 * scaleFactor;
            if (platformCount > 40) {
                width = Math.max(25 * scaleFactor, 100 * scaleFactor - (platformCount - 40) * 0.5 * scaleFactor);
            }
            const platform = document.createElement('div');
            platform.className = `platform`;
            platform.style.left = `${x}px`;
            platform.style.top = `${y}px`;
            platform.style.width = `${width}px`;
            platform.style.height = `${30 * scaleFactor}px`; // Увеличено в 2 раза (было 15)
            platform.dataset.count = platformCount;
            gameContainer.appendChild(platform);
            const platformObj = { 
                x, 
                y, 
                element: platform, 
                width: width, 
                id: Date.now() + platformCount, 
                count: platformCount,
                speed: platformCount >= 90 ? (Math.random() * 8 - 4) * scaleFactor : (platformCount >= 20 ? (Math.random() > 0.5 ? 2 * scaleFactor : -2 * scaleFactor) : 0)
            };
            platforms.push(platformObj);

            if (platformCount % 20 === 0) {
                addBonus('heart', platformObj);
            } else if (platformCount % 8 === 0) {
                addBonus('food', platformObj);
            }

            if ([7, 15, 20, 29].includes(platformCount) || (platformCount >= 100 && platformCount % 10 === 0)) {
                addSpikes(platformObj);
            }
        }

        function addBonus(type, platform) {
            const bonus = {
                x: platform.x + platform.width / 2 - (type === 'food' ? 20 * scaleFactor : 20 * scaleFactor),
                y: platform.y - 50 * scaleFactor, // Смещено выше из-за увеличенной платформы
                type: type,
                element: document.createElement('div'),
                parentPlatform: platform
            };
            bonus.element.className = `bonus ${type === 'heart' ? 'heart-bonus' : 'food-bonus'}`;
            bonus.element.style.left = `${bonus.x}px`;
            bonus.element.style.top = `${bonus.y}px`;
            bonus.element.style.width = `${type === 'food' ? 40 * scaleFactor : 40 * scaleFactor}px`; // Увеличено в 2 раза (было 20)
            bonus.element.style.height = `${type === 'food' ? 60 * scaleFactor : 40 * scaleFactor}px`; // Увеличено в 2 раза (было 30 и 20)
            gameContainer.appendChild(bonus.element);
            bonuses.push(bonus);
            console.log(`Бонус появился: ${type === 'heart' ? 'сердце' : 'еда'} на платформе ${platform.count}, x: ${bonus.x}, y: ${bonus.y}`);
        }

        function addSpikes(platform) {
            const spikeWidth = platform.width * 0.2;
            const spikeHeight = 10 * scaleFactor;
            const spikeX = platform.x + (platform.width - spikeWidth) * Math.random();
            const spikeY = platform.y - spikeHeight;

            const spikeContainer = document.createElement('div');
            spikeContainer.className = 'spikes';
            spikeContainer.style.left = `${spikeX}px`;
            spikeContainer.style.top = `${spikeY}px`;
            spikeContainer.style.width = `${spikeWidth}px`;
            spikeContainer.style.height = `${spikeHeight}px`;
            gameContainer.appendChild(spikeContainer);

            const spikeCount = Math.floor(spikeWidth / (10 * scaleFactor));
            for (let i = 0; i < spikeCount; i++) {
                const spike = document.createElement('div');
                spike.className = 'spike';
                spike.style.left = `${(i * 10 * scaleFactor) + (spikeWidth - spikeCount * 10 * scaleFactor) / 2}px`;
                spike.style.top = `0`;
                spikeContainer.appendChild(spike);
            }

            const spikeObj = {
                x: spikeX,
                y: spikeY,
                width: spikeWidth,
                height: spikeHeight,
                element: spikeContainer,
                active: true,
                parentPlatform: platform
            };
            spikes.push(spikeObj);
            console.log(`Шипы добавлены на платформу ${platform.count}, x: ${spikeX}, y: ${spikeY}`);
        }

        function gameLoop() {
            if (!gameActive) return;

            updatePlatforms();

            if (movingLeft) {
                catX -= 5 * scaleFactor;
                if (catFacingRight) {
                    cat.style.transform = 'scaleX(-1)'; // Смотрит влево
                    catFacingRight = false;
                }
            }
            if (movingRight) {
                catX += 5 * scaleFactor;
                if (!catFacingRight) {
                    cat.style.transform = 'scaleX(1)'; // Смотрит вправо
                    catFacingRight = true;
                }
            }

            catX = Math.max(0, Math.min(baseWidth - 48 * scaleFactor, catX));

            if (currentPlatform && currentPlatform.count >= 20 && !isJumping) {
                catX += currentPlatform.speed;
                catX = Math.max(0, Math.min(baseWidth - 48 * scaleFactor, catX));
            }

            if (isJumping) {
                const previousY = catY;
                catY += velocityY;
                velocityY += 0.5 * scaleFactor;

                if (currentPlatform && 
                    catY + 40 * scaleFactor >= currentPlatform.y && 
                    previousY + 40 * scaleFactor <= currentPlatform.y + 30 * scaleFactor && 
                    catX + 48 * scaleFactor > currentPlatform.x && 
                    catX < currentPlatform.x + currentPlatform.width && 
                    velocityY >= 0) {
                    catY = currentPlatform.y - 40 * scaleFactor;
                    isJumping = false;
                    velocityY = 0;
                    cat.style.animation = '';
                    console.log('Кот приземлился на текущую платформу после прыжка');
                }
            }

            const onPlatform = platforms.find(p => 
                catY + 40 * scaleFactor >= p.y && 
                catY + 40 * scaleFactor <= p.y + 30 * scaleFactor && // Учитываем новую высоту платформы
                catX + 48 * scaleFactor > p.x && 
                catX < p.x + p.width
            );

            if (onPlatform && velocityY >= 0) {
                catY = onPlatform.y - 40 * scaleFactor;
                isJumping = false;
                velocityY = 0;
                cat.style.animation = '';
                currentPlatform = onPlatform;
            } else if (!onPlatform && !isJumping && currentPlatform) {
                if (catX + 48 * scaleFactor <= currentPlatform.x || catX >= currentPlatform.x + currentPlatform.width) {
                    isJumping = true;
                    console.log('Кот вышел за границы платформы, падение началось');
                }
            }

            if (catY >= baseHeight && lives > 0) {
                lives--;
                meowSound.play();
                catY = currentPlatform ? currentPlatform.y - 40 * scaleFactor : platforms[0].y - 40 * scaleFactor;
                catX = currentPlatform ? currentPlatform.x + currentPlatform.width / 2 - 24 * scaleFactor : platforms[0].x + platforms[0].width / 2 - 24 * scaleFactor;
                isJumping = false;
                velocityY = 0;
                cat.style.animation = '';
                cat.classList.add('blink');
                setTimeout(() => cat.classList.remove('blink'), 2000);
                updateLives();
                console.log(`Жизнь потеряна, возвращён на платформу на высоте ${catY + 40 * scaleFactor}`);
                if (!currentPlatform) currentPlatform = platforms[0];
                if (lives <= 0) return endGame();
            }

            adjustWorld();
            cat.style.left = `${catX}px`;
            cat.style.top = `${catY}px`;
            checkCollisions();
            if (nut) updateNut();

            if (score >= 1000 && !hasWon) {
                gameActive = false;
                movingLeft = false;
                movingRight = false;
                winScreen.style.display = 'block';
                hasWon = true;
            }

            if (dog) updateDog();
            requestAnimationFrame(gameLoop);
        }

        function jump() {
            if (!gameActive || isJumping) return;
            const onPlatform = platforms.some(p => Math.abs(catY - (p.y - 40 * scaleFactor)) < 5 * scaleFactor);
            if (onPlatform) {
                isJumping = true;
                velocityY = -15 * scaleFactor;
                cat.style.animation = 'jumpAnimation 0.5s ease-in-out';
                jumpSound.play();
                console.log('Прыжок начался');
            }
        }

        function moveLeft(state) {
            if (!gameActive) return;
            movingLeft = state;
            console.log(`Движение влево: ${state ? 'начато' : 'остановлено'}`);
        }

        function moveRight(state) {
            if (!gameActive) return;
            movingRight = state;
            console.log(`Движение вправо: ${state ? 'начато' : 'остановлено'}`);
        }

        function updatePlatforms() {
            platforms.forEach(p => {
                if (p.count >= 20) {
                    p.x += p.speed;
                    if (p.x <= 0) p.speed = Math.abs(p.speed);
                    if (p.x >= baseWidth - p.width) p.speed = -Math.abs(p.speed);
                    p.element.style.left = `${p.x}px`;
                }
            });

            bonuses.forEach(b => {
                if (b.parentPlatform.count >= 20) {
                    b.x = b.parentPlatform.x + b.parentPlatform.width / 2 - (b.type === 'food' ? 20 * scaleFactor : 20 * scaleFactor);
                    b.element.style.left = `${b.x}px`;
                }
            });

            spikes.forEach(s => {
                if (s.active && s.parentPlatform.count >= 20) {
                    s.x = s.parentPlatform.x + (s.parentPlatform.width - s.width) * (s.x - s.parentPlatform.x) / s.parentPlatform.width;
                    s.element.style.left = `${s.x}px`;
                }
            });
        }

        function adjustWorld() {
            if (catY < baseHeight / 2) {
                worldOffset = baseHeight / 2 - catY;
                catY = baseHeight / 2;
                platforms.forEach(p => {
                    p.y += worldOffset;
                    p.element.style.top = `${p.y}px`;
                });
                bonuses.forEach(b => {
                    b.y += worldOffset;
                    b.element.style.top = `${b.y}px`;
                });
                spikes.forEach(s => {
                    s.y += worldOffset;
                    s.element.style.top = `${s.y}px`;
                });
                if (dog) {
                    dog.y += worldOffset;
                    dog.element.style.top = `${dog.y}px`;
                };
                if (nut) {
                    nut.y += worldOffset;
                    nut.element.style.top = `${nut.y}px`;
                }
                if (platforms[0].y > baseHeight) {
                    platforms.shift().element.remove();
                    addNewPlatform();
                }
                worldOffset = 0;
            }
        }

        function checkCollisions() {
            platforms.forEach(p => {
                if (
                    catY + 40 * scaleFactor >= p.y && 
                    catY + 40 * scaleFactor <= p.y + 30 * scaleFactor && 
                    catX + 48 * scaleFactor > p.x && 
                    catX < p.x + p.width
                ) {
                    if (velocityY >= 0) {
                        catY = p.y - 40 * scaleFactor;
                        isJumping = false;
                        velocityY = 0;
                        cat.style.animation = '';
                        if (!visitedPlatforms.has(p.id)) {
                            visitedPlatforms.add(p.id);
                            animateScore(score, score + 10);
                            steps++;
                            updateSteps();
                        }
                        currentPlatform = p;
                    }
                }
            });

            bonuses.forEach((b, index) => {
                const bonusWidth = b.type === 'food' ? 40 * scaleFactor : 40 * scaleFactor;
                const bonusHeight = b.type === 'food' ? 60 * scaleFactor : 40 * scaleFactor;
                if (
                    catX + 48 * scaleFactor > b.x && 
                    catX < b.x + bonusWidth && 
                    catY + 40 * scaleFactor > b.y && 
                    catY < b.y + bonusHeight
                ) {
                    bonusSound.play();
                    if (b.type === 'heart') {
                        if (lives < 5) {
                            lives++;
                            updateLives();
                            console.log(`Собрано сердце, жизней: ${lives}`);
                            showStarParticles(b.x + bonusWidth / 2, b.y);
                        } else {
                            animateScore(score, score + 100);
                            showScorePopup('+100', 'heart-pop');
                            console.log(`Собрано сердце, +100 очков, очки: ${score}`);
                            showStarParticles(b.x + bonusWidth / 2, b.y);
                        }
                    } else if (b.type === 'food') {
                        animateScore(score, score + 50);
                        showScorePopup('+50', 'food-pop');
                        console.log(`Собрана еда, +50 очков, очки: ${score}`);
                        showStarParticles(b.x + bonusWidth / 2, b.y);
                    }
                    b.element.remove();
                    bonuses.splice(index, 1);
                }
            });

            spikes.forEach((s, index) => {
                if (s.active && 
                    catX + 48 * scaleFactor > s.x && 
                    catX < s.x + s.width && 
                    catY + 40 * scaleFactor > s.y && 
                    catY < s.y + s.height && 
                    lives > 0) {
                    lives--;
                    meowSound.play();
                    updateLives();
                    cat.classList.add('blink');
                    setTimeout(() => cat.classList.remove('blink'), 2000);
                    console.log(`Кот коснулся шипов, жизнь потеряна, жизней: ${lives}`);
                    s.element.remove();
                    s.active = false;
                    spikes.splice(index, 1);
                    if (lives <= 0) endGame();
                }
            });

            if (nut && 
                catX + 48 * scaleFactor > nut.x && 
                catX < nut.x + 20 * scaleFactor && 
                catY + 40 * scaleFactor > nut.y && 
                catY < nut.y + 20 * scaleFactor && 
                lives > 0) {
                lives--;
                meowSound.play();
                updateLives();
                cat.classList.add('blink');
                setTimeout(() => cat.classList.remove('blink'), 2000);
                console.log(`Орешек попал, жизнь потеряна, жизней: ${lives}`);
                nut.element.remove();
                nut = null;
                if (lives <= 0) endGame();
            }

            if (dog && 
                catX + 48 * scaleFactor > dog.x && 
                catX < dog.x + 80 * scaleFactor && 
                catY + 40 * scaleFactor > dog.y && 
                catY < dog.y + 60 * scaleFactor && 
                lives > 0) {
                lives = 0;
                meowSound.play();
                updateLives();
                endGame();
            }
        }

        function showStarParticles(x, y) {
            for (let i = 0; i < 6; i++) {
                const star = document.createElement('div');
                star.className = 'star-particle';
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 20 * scaleFactor;
                const dx = Math.cos(angle) * distance;
                const dy = Math.sin(angle) * distance;
                star.style.left = `${x}px`;
                star.style.top = `${y}px`;
                star.style.setProperty('--dx', `${dx}px`);
                star.style.setProperty('--dy', `${dy}px`);
                gameContainer.appendChild(star);
                setTimeout(() => star.remove(), 500);
            }
        }

        function animateScore(start, end) {
            let current = start;
            const increment = (end - start) / 20;
            const duration = 500;
            const stepTime = duration / 20;

            function step() {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    score = end;
                    scoreDisplay.textContent = `Очки: ${Math.round(score)}`;
                } else {
                    scoreDisplay.textContent = `Очки: ${Math.round(current)}`;
                    setTimeout(step, stepTime);
                }
            }

            step();
            score = end;
        }

        function showScorePopup(text, type) {
            const popup = document.createElement('div');
            popup.className = `score-pop ${type}`;
            popup.textContent = text;
            popup.style.left = `${catX + 24 * scaleFactor}px`;
            popup.style.top = `${catY - 20 * scaleFactor}px`;
            popup.style.fontSize = `${24 * scaleFactor}px`;
            gameContainer.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        }

        function spawnDogRandomly() {
            if (!gameActive) return;
            const baseInterval = platformCount >= 30 ? 7500 : 15000;
            setTimeout(() => {
                if (!dog && gameActive) spawnDog();
                spawnDogRandomly();
            }, Math.random() * baseInterval + baseInterval);
        }

        function spawnDog() {
            dog = {
                x: -80 * scaleFactor,
                y: currentPlatform ? currentPlatform.y - 60 * scaleFactor : baseHeight - 40 * scaleFactor,
                element: document.createElement('div')
            };
            dog.element.id = 'dog';
            dog.element.style.left = `${dog.x}px`;
            dog.element.style.top = `${dog.y}px`;
            dog.element.style.width = `${80 * scaleFactor}px`;
            dog.element.style.height = `${60 * scaleFactor}px`;
            gameContainer.appendChild(dog.element);
            woofSound.play();
        }

        function updateDog() {
            dog.x += 5 * scaleFactor;
            dog.element.style.left = `${dog.x}px`;
            if (dog.x > baseWidth) {
                dog.element.remove();
                dog = null;
            }
        }

        function spawnNutRandomly() {
            if (!gameActive) return;
            setTimeout(() => {
                if (!nut && gameActive) spawnNut();
                spawnNutRandomly();
            }, Math.random() * 5000 + 10000);
        }

        function spawnNut() {
            nut = {
                x: Math.random() * (baseWidth - 20 * scaleFactor),
                y: -20 * scaleFactor,
                element: NonDocumentFragmentBuilder.createElement('div')
            };
            nut.element.id = 'nut';
            nut.element.style.left = `${nut.x}px`;
            nut.element.style.top = `${nut.y}px`;
            nut.element.style.width = `${20 * scaleFactor}px`;
            nut.element.style.height = `${20 * scaleFactor}px`;
            gameContainer.appendChild(nut.element);
            nutSound.play();
        }

        function updateNut() {
            nut.y += 5 * scaleFactor;
            nut.element.style.top = `${nut.y}px`;
            if (nut.y > baseHeight) {
                nut.element.remove();
                nut = null;
            }
        }

        function updateScore() {
            scoreDisplay.textContent = `Очки: ${score}`;
            scoreDisplay.style.transform = 'scale(1.2)';
            setTimeout(() => scoreDisplay.style.transform = 'scale(1)', 200);
        }

        function updateSteps() {
            stepsDisplay.textContent = `Ступень: ${steps}`;
        }

        function updateLives() {
            livesDisplay.innerHTML = '';
            for (let i = 0; i < lives; i++) {
                const heart = document.createElement('span');
                heart.className = 'heart';
                heart.style.width = `${25 * scaleFactor}px`;
                heart.style.height = `${25 * scaleFactor}px`;
                livesDisplay.appendChild(heart);
            }
        }

        function endGame() {
            gameActive = false;
            movingLeft = false;
            movingRight = false;
            gameOver.style.display = 'block';
            finalScore.textContent = `Очки: ${score}`;
            finalSteps.textContent = `Ступеней: ${steps}`;
            if (dog) {
                dog.element.remove();
                dog = null;
            }
            if (nut) {
                nut.element.remove();
                nut = null;
            }
        }

        function continueGame() {
            winScreen.style.display = 'none';
            gameActive = true;
            movingLeft = false;
            movingRight = false;
            gameLoop();
        }

        function restartGame() {
            gameOver.style.display = 'none';
            winScreen.style.display = 'none';
            platforms.forEach(p => p.element.remove());
            bonuses.forEach(b => b.element.remove());
            spikes.forEach(s => s.element.remove());
            if (dog) dog.element.remove();
            if (nut) nut.element.remove();
            dog = null;
            nut = null;
            catX = platforms[0] ? platforms[0].x + platforms[0].width / 2 - 24 * scaleFactor : baseWidth / 2 - 24 * scaleFactor;
            catY = platforms[0] ? platforms[0].y - 40 * scaleFactor : baseHeight - 40 * scaleFactor;
            movingLeft = false;
            movingRight = false;
            startGame(selectedCat);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') moveLeft(true);
            if (e.key === 'ArrowRight') moveRight(true);
            if (e.key === ' ') jump();
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft') moveLeft(false);
            if (e.key === 'ArrowRight') moveRight(false);
        });

        document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
    </script>
</body>
</html>
